<div class="widget">
  <mat-card class="table">
    <mat-card-header>

      <div mat-card-avatar class="pull-right">
        <img [src]="'/assets/icons/' + icon  +'.svg'" />
      </div>

      <mat-card-title>
        {{title}}
      </mat-card-title>

      <mat-card-subtitle>
        {{subtitle}}
      </mat-card-subtitle>

      <div class="menu">
        <img [src]="'/assets/icons/' + 'office-paper-work-bag'  +'.svg'" />
      </div>

      <div class="search" [class.active]="mode == 'report'" (click)="mode = mode == 'report' ? 'data':'report'">
        <img [src]="'/assets/icons/' + 'search'  +'.svg'" />
      </div>

    </mat-card-header>
    <mat-card-content>

      <div class="report-model" *ngIf="mode == 'report' && report">


        <!-- <textarea name="" class="logbox" id="" cols="30" rows="10">{{report.fields | json}}</textarea> -->
        <div class="fields">

          <app-form-select-input [data]="reports" [selectType]="'single'" [label]="'انتخاب از گزارشات ذخیره شده'"
            (modelChange)="changeReport($event)" [model]="report._id"></app-form-select-input>

          <app-form-text-input *ngIf="!report._id" [label]="'نام گزارش جدید'" (modelChange)="report.label = $event"
            [model]="report.label"></app-form-text-input>

          <div class="field" *ngFor="let field of report.fields">

            <div class="field-name">
              <mat-slide-toggle [(ngModel)]="field.enabled" (change)="modelChange()">
                {{field.label}}
              </mat-slide-toggle>
            </div>

            <div class="template-inputs" *ngIf="field.templateInputsForm && field.enabled">
              <app-form [defaultModel]="field.templateInputs || {}" (WidgetChange)="field.templateInputs = $event.inputs.model "
                [formType]="'inline'" [name]="field.templateInputsForm"></app-form>
            </div>
            <div class="property-query" *ngIf="field.enabled && field.queries && field.queries.length > 0">

              <div class="double-field">
                <app-form-select-input [class.w-100]="findEnabledFieldQuery(field)" [class.w-80]="findEnabledFieldQuery(field)"
                  [data]="field.queries" [label]="findEnabledFieldQuery(field) ? '' : 'انتخاب از فیلترها'" [selectType]="'single'"
                  [model]="findEnabledFieldQuery(field)" (modelChange)="fieldQuerySelect(field,$event)"></app-form-select-input>
                <div class="reset-query w-20">
                  <img *ngIf="findEnabledFieldQuery(field)" (click)="findEnabledFieldQuery(field).enabled = false"
                    class="" src="assets/icons/close-4.svg" />
                </div>
              </div>


              <app-form *ngIf="findEnabledFieldQuery(field)" [formType]="'inline'" [defaultModel]="findEnabledFieldQuery(field).methodInput || {}"
                (WidgetChange)="findEnabledFieldQuery(field).methodInput = $event.inputs.model " [name]="findEnabledFieldQuery(field).methodInputForm"></app-form>

            </div>
            <!--
            <div class="property-query" *ngFor="let query of !field.enabled ? [] : field.queries ">

              {{query.methodInputForm}}
              <label for="">
                {{query.label}}
              </label>

              <app-form [formType]="'inline'" [defaultModel]="query.methodInput || {}" (WidgetChange)="query.methodInput = $event.inputs.model "
                [name]="query.methodInputForm"></app-form>

            </div> -->


          </div>


        </div>

      </div>


      <div class="report-result" [style.overflowX]="resultLoading ? 'hidden' : 'scroll'" *ngIf="report && mode == 'data'">

        <div class="report-header">

          <div class="select">
            <mat-checkbox (change)="allSelectChange($event)" [checked]="allSelected()"></mat-checkbox>
          </div>
          <div class="field-label" *ngFor="let field of  enabledReportFields()">
            <ndc-dynamic *ngIf="  field.template && field.template != 'json'" [ndcDynamicInputs]="extendObj( { label : field.label , viewType : 'label' } )"
              [ndcDynamicOutputs]="{  widgetCommand : DashboardCommand.emit   }" [ndcDynamicComponent]="getViewComponent(field.template)"></ndc-dynamic>
          </div>
        </div>

        <mat-progress-bar *ngIf="resultLoading" [color]="'warn'" [mode]="'indeterminate'">
        </mat-progress-bar>

        <div class="records" *ngIf="!resultLoading">
          <div class="record" *ngFor="let record of page;trackBy: trackByFn">

            <div class="select">
              <mat-checkbox [checked]="selected.indexOf(record._id) != -1" (change)="recordSelectChange(record._id,$event)"></mat-checkbox>
            </div>

            <div class="field" *ngFor="let field of enabledReportFields()">

              <div class="json" *ngIf="field.template == 'json'">
                {{record[field.name] | json}}
              </div>

              <div class="raw" *ngIf="!field.template">
                {{record[field.name]}}
              </div>

              <ndc-dynamic *ngIf="field.template && field.template != 'json'" [ndcDynamicInputs]="extendObj( { label : field.label , model : record[field.name] }, field.templateInputs ||  field.templateInputs || {})"
                [ndcDynamicOutputs]="{  widgetCommand : DashboardCommand.emit   }" [ndcDynamicComponent]="getViewComponent(field.template)"></ndc-dynamic>
            </div>

          </div>
        </div>
      </div>

    </mat-card-content>

    <mat-card-actions *ngIf="report && mode == 'report'">
      <button mat-raised-button [color]="'primary'" (click)="mode = 'data';refresh()">
        <img src="assets/icons/seen-visible-1.svg" />
        مشاهده نتیجه </button>


      <div class="clearfix"></div>
    </mat-card-actions>


    <mat-card-actions *ngIf="report && mode == 'data'">

      <button mat-button>{{ entityLabelSingular }} جدید </button>
      <button (click)="edit()" *ngIf="selected.length > 0" mat-button>

         ویرایش {{ (selected.length > 1 ? selected.length : '') | rpd}} {{ entityLabelSingular }}  انتخاب‌شده

        </button>

      <div class="paginator pull-left" *ngIf="report && report.count">

        <div class="next" *ngIf="pageIndex < pageCount" (click)="changePage(1)">
          <img src="assets/icons/arrow-left-back-10.svg" />
        </div>
        <div class="current">
          {{ pageIndex + 1 | rpd }}
          -
          {{ pageCount | rpd }}
        </div>
        <div class="prev" *ngIf="pageIndex >= 1" (click)="changePage(-1)">
          <img src="assets/icons/arrow-right-next-10.svg" />
        </div>
      </div>

      <button mat-button class="pull-left" *ngIf="!report._id" (click)="saveReport()">
        <img src="assets/icons/save-backup-1.svg" *ngIf="!report.offline" />
        <img src="assets/icons/check-9.svg" *ngIf="report.offline" />
        ذخیره
      </button>

      <button mat-button class="pull-left" *ngIf="report._id" (click)="report.offline ? deleteOffline() : saveOffline()">
        <img src="assets/icons/save-backup-1.svg" *ngIf="!report.offline" />
        <img src="assets/icons/check-9.svg" *ngIf="report.offline" />
        آفلاین
      </button>

      <div class="clearfix"></div>
    </mat-card-actions>


  </mat-card>
</div>
